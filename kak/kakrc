# set-option -add global autoinfo normal
set-option global scrolloff 3,3
set-option global ui_options ncurses_assistant=none
set-option global tabstop 4

# clean selections and search highlight on Esc
map global normal <esc> '<space><semicolon>: reg slash ""<ret>'

# highlight delimiter matches
add-highlighter global/match show-matching

# underline search matches
add-highlighter global/search dynregex '%reg{/}' 0:+u

# comment maps
map global normal '#'   ': comment-line<ret>'  -docstring "comment line"
map global normal <a-#> ': comment-block<ret>' -docstring "comment block"

# find non-ascii chars quickly
define-command non-ascii -docstring "search for non-ascii characters" %{
    set-register / '[^\x00-\x7f]'
}

colorscheme mysticaltutor-alpha

# tmux window management commands
define-command -docstring "vsplit [<commands>]: split tmux vertically" \
vsplit -params .. -command-completion %{
    tmux-terminal-horizontal kak -c %val{session} -e "%arg{@}"
}
define-command -docstring "split [<commands>]: split tmux horizontally" \
split -params .. -command-completion %{
    tmux-terminal-vertical kak -c %val{session} -e "%arg{@}"
}
define-command -docstring "tabnew [<commands>]: create new tmux window" \
tabnew -params .. -command-completion %{
    tmux-terminal-window kak -c %val{session} -e "%arg{@}"
}

# pylint
hook global WinSetOption filetype=python %{
    set window lintcmd %{ run() { pylint -d C0111,C0301,C0103,E1101 --msg-template='{path}:{line}:{column}: {category}: {msg_id}: {msg} ({symbol})' "$1" | awk -F: 'BEGIN { OFS=":" } { if (NF == 6) { $3 += 1; print } }'; } && run }
}

# find-edit command
define-command find-edit -params 1 -menu -shell-script-candidates 'fd --type file || rg --files' 'edit %arg(1)'
map global user f ': find-edit ' -docstring "find and edit file"

# unify next/prev
hook global BufOpenFifo '\*make\*' %{ alias global next make-next-error; alias global prev make-previous-error }
hook global BufOpenFifo '\*grep\*' %{ alias global next grep-next-match; alias global prev grep-previous-match }
hook global BufCreate '\*find\*' %{ alias global next find-next-match; alias global prev find-previous-match }
hook global BufOpenFifo '\*lint-output\*' %{ alias global next lint-next-message; alias global prev lint-previous-message }
hook global BufCreate '\*references\*' %{ alias global next lsp-references-next-match; alias global prev lsp-references-previous-match }
hook global BufCreate '\*diagnostics\*' %{ def next "lsp-find-error --include-warnings"; def prev "lsp-find-error --previous --include-warnings" }

map global user n     ': next<ret>' -docstring "next message"
map global user <a-n> ': prev<ret>' -docstring "previous message"

## self plugin settings
# options.kak
map global user c ': cursorline-toggle<ret>'   -docstring "toggle cursorline highlighting"
map global user l ': line-numbers-toggle<ret>' -docstring "toggle line-numbers"
map global user s ': whitespaces-toggle<ret>'  -docstring "toggle whitespace highlighting"
map global user w ': softwrap-toggle<ret>'     -docstring "toggle line soft wrap"
hook global WinCreate ^[^*]+$ %{ line-numbers-toggle }
hook global WinCreate .* %{ softwrap-toggle }

# clipboard.kak: clipboard sync on explicit yank
hook global NormalKey y clipboard-sync

# percent.kak
map global goto p '<esc>: percent<ret>' -docstring "buffer percentage"

# inc-dec.kak
declare-user-mode inc-dec
map global inc-dec a ': inc-dec %val{count} + 0<ret>' -docstring "increment by count"
map global inc-dec x ': inc-dec %val{count} - 0<ret>' -docstring "decrement by count"
map global inc-dec A ': inc-dec %val{count} + 1<ret>' -docstring "increment by count times selection index"
map global inc-dec X ': inc-dec %val{count} - 1<ret>' -docstring "decrement by count times selection index"
map global user m ': enter-user-mode inc-dec<ret>'       -docstring "enter inc-dec mode"
map global user M ': enter-user-mode -lock inc-dec<ret>' -docstring "enter inc-dec mode (lock)"

## remote plugin settings
source "%val{config}/plugins/plug.kak/rc/plug.kak"
plug "andreyorst/plug.kak" domain "gitlab.com" noload

plug "occivink/kakoune-find"
plug "Screwtapello/kakoune-shellcheck" domain "gitlab.com"

# enable lsp for filetypes, kak-lsp not managed by plug
hook global WinSetOption filetype=(rust|python|c|cpp) %{
    evaluate-commands %sh{ kak-lsp --kakoune -s "$kak_session" }

    define-command lsp-restart %{ lsp-stop; lsp-start }
    set-option global lsp_diagnostic_line_error_sign "!"
    set-option global lsp_diagnostic_line_warning_sign "?"
    set-face window DiagnosticError default+u
    set-face window DiagnosticWarning default+u

    lsp-enable-window
    lsp-auto-hover-enable

    map window user l ': enter-user-mode lsp<ret>' -docstring "LSP mode"
    map window normal <F9> ': tool lsp-diagnostics<ret>'
    map window goto r '<esc>: tool lsp-references<ret>' -docstring "references"
}

plug "andreyorst/smarttab.kak" domain "gitlab.com" defer smarttab %{
    set-option global softtabstop 4
} config %{
    hook global WinSetOption filetype=(python|rust|markdown|kak|lisp|scheme|sh|fish|perl|yaml) expandtab
    hook global WinSetOption filetype=(makefile) noexpandtab
    hook global WinSetOption filetype=(c|cpp) smarttab
}

plug "Delapouite/kakoune-buffers" config %{
    map global normal <backspace>   ': enter-buffers-mode<ret>'            -docstring "enter buffers mode"
    map global normal <a-backspace> ': enter-user-mode -lock buffers<ret>' -docstring "enter buffers mode (lock)"
    hook global WinDisplay .* info-buffers
}

plug "chambln/kakoune-readline" config %{
    hook global WinCreate .* readline-enable
}

plug "alexherbo2/surround.kak" config %{
    map global normal <a-g> ': surround<ret>' -docstring "enter surround mode"
}

plug "occivink/kakoune-vertical-selection" config %{
    map global normal ^     ': vertical-selection-down<ret>' -docstring "select matching pattern from the lines below"
    map global normal <a-^> ': vertical-selection-up<ret>'   -docstring "select matching pattern from the lines above"
}

plug "occivink/kakoune-expand" config %{
    map global normal + ": expand<ret>"
    set-option -add global expand_commands %{
        expand-impl %{ exec <a-i>p }
        # lower indent level
        expand-impl %{ exec '<a-;>k<a-a>i' }
        # expand back to pythonic "...:" lines
        expand-impl %{ exec '<a-i>i<a-:><a-;><a-?>^[^\n]+:<ret><a-;>' }
    }
}

plug "Screwtapello/kakoune-state-save" domain "gitlab.com" config %{
    hook global KakBegin .* %{
        state-save-reg-load colon
        state-save-reg-load pipe
        state-save-reg-load slash
    }
    hook global KakEnd .* %{
        state-save-reg-save colon
        state-save-reg-save pipe
        state-save-reg-save slash
    }
}
